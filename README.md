# Micronaut Graal Native Image Custom Runtime AWS Cloudformation 
## Greeting service example  

The Micronaut framework is compatible with Spring's annotations and makes it easy to use GraalVM to build application images into native binaries. Further, Micronaut includes builtin support for AWS Lambda.

This demo application shows how to use Micronaut to compile an application that uses Spring annotations into a native binary with GraalVM and execute it in AWS Lambda. To run this demo, you will need to have Gradle installed as well as Docker to run the GraalVM build.

With all the pre-requisites installed including:

* JDK 8 or above
* Gradle 5.6.x
* Docker
 
You should be able to build a native image of the application by running the `docker-build.sh` from the repository's root.

```bash
$ ./docker-build.sh
```

The build process will perform the following tasks:
1. Use gradle to compile the application
2. Create a `native-image` folder in the current directory
3. Check if a Docker image called `graalvm-lambda-build` exists on the local machine. If not, create it using the `Dockerfile` in the root of the repository
4. Run the docker image to execute the GraalVM build process

The output of the build is an executable file called `server` and a deployable zip called `function.zip` in the `native-image` folder:

```bash
$ ls -lh native-image/
total 75M
-rwxr-xr-x 1 user user  36 Oct  1 16:01 bootstrap
-rw-r--r-- 1 user user 18M Oct  1 16:01 function.zip
-rwxr-xr-x 1 user user 57M Oct  1 16:01 server
```

To test the lambda locally utilizing [AWS SAM](https://aws.amazon.com/serverless/sam/), simply run the `./sam-local.sh` script, which utilizes the `sam-native.yml` config file.

You can then make a request to the local endpoint with curl or whichever your http client of choice:
```bash
curl localhost:3000/hello/$name
```

To deploy the application to AWS Lambda run the following commands:

```bash
$ aws cloudformation package --template-file sam-native.yaml \
                             --output-template-file packaged-sam.yaml \
                             --s3-bucket <YOUR_S3_BUCKET>
Uploading to d3e2617f3c8c2e8ca78e35a0dc856884  18553505 / 18553505.0  (100.00%)
Successfully packaged artifacts and wrote output template to file packaged-sam.yaml.
Execute the following command to deploy the packaged template
aws cloudformation deploy --template-file /workspace/graal-spring-demo/packaged-sam.yaml --stack-name <YOUR STACK NAME>


$ aws cloudformation deploy --template-file ./packaged-sam.yaml --stack-name MicronautGraalVmDemo --capabilities CAPABILITY_IAM

Waiting for changeset to be created..
Waiting for stack create/update to complete
Successfully created/updated stack - MicronautGraalVmDemo
```

You can use the AWS CLI to get the API endpoint generated by the deployment process:

```bash
aws cloudformation describe-stacks --stack-name MicronautGraalVmDemo --query "Stacks[0].Outputs[0].OutputValue"
"https://xxxxxxxxxx.execute-api.xx-xxxx-1.amazonaws.com/Prod/hello/$name"
```
